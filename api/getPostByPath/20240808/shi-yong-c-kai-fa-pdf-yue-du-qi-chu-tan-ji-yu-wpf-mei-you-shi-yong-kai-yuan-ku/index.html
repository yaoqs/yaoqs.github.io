{"type":"getPostByPath","data":{"title":"使用C#开发pdf阅读器初探（基于WPF，没有使用开源库）","date":"2024-08-08T06:40:08.000Z","description":"","categories":[{"name":"pdf","_id":"clzpq9hx2007rsgerd1xi7o74"},{"name":"wpf","_id":"clzpq9hxn008msger8k5cfcgh"}],"tags":[{"name":"pdf","_id":"clzpq9hzh00bysger6j1m5thy"},{"name":"wpf","_id":"clzpq9hzi00c0sger3lom6jqx"}],"content":"<p>转载自 <a href=\"https://www.cnblogs.com/yuanchenhui/p/pdf-reader.html\">使用C#开发pdf阅读器初探（基于WPF，没有使用开源库）</a></p>\n<h2 id=\"前言\"><a class=\"header-anchor\" href=\"#前言\">※</a>前言</h2>\n<p>pdf是最流行的版式格式文件标准，已成为国际标准。pdf相关的开源软件非常多，也基本能满足日常需要了。相关商业软件更是林林总总，几乎应有尽有！似乎没必要自己再独立自主开发！但，本人基于以下考虑，决定自主研发一款pdf阅读器。</p>\n<ol>\n<li>通过编写pdf阅读器，可以迅速的熟悉pdf文件的处理。pdf格式包含的内容非常多，仅仅通过查资料，很难掌握其内容。</li>\n<li>任何技术，只有自主可控，才能到达气定神闲！使用开源软件是简单，万一遇到问题，就是个坑！</li>\n<li>解决pdf与ofd互转问题。ofd是国家标准，相关的处理软件非常少。为了解决两种格式文件互转，必须了解pdf。</li>\n<li>本人此前开发了一款ofd阅读器，积累了一些经验。为开发pdf阅读器增添了信心。</li>\n</ol>\n<p>特别说明 本人花了几周写了这款阅读器，验证了pdf不同类型的数据处理，还远远到不了商用的要求。不积跬步无以至千里！本人会慢慢完善这款软件，敬请期待。本人的参考资料有两本英文书籍和pdf英文标准文档。</p>\n<p>程序界面： <a href=\"pdf%E9%98%85%E8%AF%BB%E5%99%A8%E5%92%8C%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6(QQ%E4%BA%A4%E6%B5%81%E7%BE%A4877371250).zip\">点击下载程序</a></p>\n<p><img src=\"245753-20200228235849475-2000775351.png\" alt=\"\"></p>\n<h2 id=\"pdf相关参考资料：\"><a class=\"header-anchor\" href=\"#pdf相关参考资料：\">※</a>pdf相关参考资料：</h2>\n<p><img src=\"245753-20200226204447268-443838125.png\" alt=\"\"></p>\n<p><img src=\"245753-20200226204540359-1100914526.png\" alt=\"\"></p>\n<p><img src=\"245753-20200226204202465-892102858.png\" alt=\"\"></p>\n<h2 id=\"pdf文件结构简介\"><a class=\"header-anchor\" href=\"#pdf文件结构简介\">※</a>pdf文件结构简介</h2>\n<p>pdf总的内容结构如下：</p>\n<p><img src=\"245753-20200228222905488-1998635046.png\" alt=\"\"></p>\n<ol>\n<li>header: 有关pdf版本信息。最新版为 %PDF−1. 7</li>\n<li>Body：存储具体数据，pdf就是由很多object组成的。每个object由dictionary和stream组成。dictionary存储就是key、alue字符对。dictionary是可以嵌套的，就是value有可能也是一个dictionary。</li>\n<li>Cross-Reference Table：交叉索引表。可以快速定位到具体object。便于随机读取object。</li>\n<li>Trailer：给出交叉索引表的位置。读取pdf文件都是从最后开始读的，所以Trailer一定是在文件最后。</li>\n</ol>\n<h3 id=\"pdf处理总体结构\"><a class=\"header-anchor\" href=\"#pdf处理总体结构\">※</a>pdf处理总体结构</h3>\n<p><img src=\"245753-20200228230402283-252284265.png\" alt=\"\"></p>\n<h3 id=\"object内容读取\"><a class=\"header-anchor\" href=\"#object内容读取\">※</a>object内容读取</h3>\n<p>交叉索引表能快速定位到某个object的位置，读取object内容不难，关键是分析dictionary。dictionary是可以嵌套，就是dictionary的内容还有dictionary。快速解析出所有的dictionary是处理的关键。典型的dictionary结构如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;&lt;</span><br><span class=\"line\">/Annots 68 0 R</span><br><span class=\"line\">/BleedBox [0 0 504 661.5]</span><br><span class=\"line\">/Contents [51 0 R]</span><br><span class=\"line\">/CropBox [0 0 504 661.5]</span><br><span class=\"line\">/MediaBox [0 0 504 661.5]</span><br><span class=\"line\">/Parent 4334 0 R</span><br><span class=\"line\"></span><br><span class=\"line\">/Resources</span><br><span class=\"line\">&lt;&lt; //嵌套dictionary</span><br><span class=\"line\">/ColorSpace &lt;&lt;/CS1 62 0 R&gt;&gt;  //2次嵌套dictionary</span><br><span class=\"line\">/Font &lt;&lt;/F1 7 0 R/F2 11 0 R/F3 13 0 R/F4 53 0 R&gt;&gt; //2次嵌套dictionary</span><br><span class=\"line\">/ProcSet [/PDF/Text/ImageB/ImageC] //数组</span><br><span class=\"line\">/XObject &lt;&lt;/I1 54 0 R/I2 56 0 R/I3 60 0 R&gt;&gt;//2次嵌套dictionary</span><br><span class=\"line\">&gt;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">/Type /Page</span><br><span class=\"line\">&gt;&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"页面内容分析\"><a class=\"header-anchor\" href=\"#页面内容分析\">※</a>页面内容分析</h3>\n<p>页面内容由系列操作数和操作符组成。所有的操作数和操作符在同一个文本中，所以要快速的将操作数和操作符组成可以执行的操作对。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0 0 515.95 728.6 re</span><br><span class=\"line\">W* n</span><br><span class=\"line\">0 w</span><br><span class=\"line\">2 M</span><br><span class=\"line\">2 J</span><br><span class=\"line\">2 j</span><br><span class=\"line\">0 0 0 RG</span><br><span class=\"line\">BT</span><br><span class=\"line\">0 0 0 rg</span><br><span class=\"line\">/FT8 180 Tf</span><br><span class=\"line\">/GS13 gs</span><br><span class=\"line\">0.05 0 0 -0.05 187.68 676.49 Tm</span><br><span class=\"line\">&lt;35BE&gt;Tj 180 0 TD&lt;1D5F&gt;Tj 180 0 TD&lt;4205&gt;Tj 180 0 TD&lt;4EC8&gt;Tj</span><br><span class=\"line\">ET</span><br></pre></td></tr></table></figure>\n<p>字符都是存在（）或&lt;&gt;中，除去字符和数字，就是操作符。如上文W*、n都是操作符；&lt;35BE&gt;为16进制字符对应的key，具体代表哪个字，需要到查字符表。这里的35BE并不是unicode字符对应的值，还需要再查表。如下图：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">beginbfchar</span><br><span class=\"line\">&lt;0019&gt; &lt;0036&gt;</span><br><span class=\"line\">&lt;35BE&gt; &lt;0037&gt;</span><br><span class=\"line\">&lt;001B&gt; &lt;0038&gt;</span><br><span class=\"line\">&lt;001C&gt; &lt;0039&gt;</span><br><span class=\"line\">endbfchar</span><br></pre></td></tr></table></figure>\n<p>&lt;35BE&gt;对应的是&lt;0037&gt;。该表存在字体资源文件object中。</p>\n<h2 id=\"页面显示\"><a class=\"header-anchor\" href=\"#页面显示\">※</a>页面显示</h2>\n<h3 id=\"坐标系变换\"><a class=\"header-anchor\" href=\"#坐标系变换\">※</a>坐标系变换</h3>\n<p>理清不同坐标系之间的关系是处理的关键。坐标系分为：Device Space（设备坐标空间）、User Space（设备坐标空间）、text space（文本坐标空间）等。</p>\n<h3 id=\"绘画上下文设置\"><a class=\"header-anchor\" href=\"#绘画上下文设置\">※</a>绘画上下文设置</h3>\n<p>当前绘画的状态（画笔、画刷等）是保存在栈中，会有入栈出栈操作。</p>\n<h3 id=\"特殊画刷处理\"><a class=\"header-anchor\" href=\"#特殊画刷处理\">※</a>特殊画刷处理</h3>\n<p>pdf有一种画刷，比如渐变色，这个很难找到现成的画刷使用。我使用的是ImageBrush，就是使用图片作为画刷。在内存中创建可擦写的图片，可以精确控制每个像素的值。根据pdf标准提供的算法，计算每个像素的值。</p>\n<p>pdf的显示大体分为三种：曲线、文本、图片。其中曲线的显示是比较麻烦的，关键是将pdf标准的描述与wpf曲线操作对应起来。</p>\n<h2 id=\"pdf阅读器开发说明\"><a class=\"header-anchor\" href=\"#pdf阅读器开发说明\">※</a>pdf阅读器开发说明</h2>\n<p>如果完全参数标准文件开发，是比较枯燥，感觉慢慢长路看不到尽头。我采用是单个功能各个击破的方法，能很快见到开发成果。我使用的参考书是《PDF Explained》，100多页，只是对pdf做大体介绍，但是各个功能点都有所提及。我就参照该书提供的示例文件，逐步验证每个文件。</p>\n<p>每种显示都有多种处理方法，每个软件生成pdf的风格是不同的。对特定的软件生成的pdf做几次验证后，基本可以保证该软件生成的pdf都可以正常显示。</p>\n<p>wps是可以直接将doc文件转换为pdf的。我对wps生成的pdf做了测试，经过几次调试，现在基本可以正常处理wps生成的pdf文件。</p>\n<p><img src=\"245753-20200228235514724-1244569766.png\" alt=\"\"></p>\n<h2 id=\"后记\"><a class=\"header-anchor\" href=\"#后记\">※</a>后记</h2>\n<p>对于开发pdf阅读器这类软件，以前都是不敢想象的。像这种复杂的软件，必须遵循一定的设计模式、正确建立域模型。所以开发这类软件，对pdf标准的理解是否深刻并非关键，关键还是编程的功底。软件的外在表现千奇百态，但内在逻辑具有类比性的。继承、封装、多态、SOLID设计准则这些并不难理解，但是要达到应用自如还需要反复锤炼。把握好每个细节，正确运用设计准则，一步一个脚印，最终会将不可能变成可能！</p>\n<h2 id=\"相关阅读\"><a class=\"header-anchor\" href=\"#相关阅读\">※</a>相关阅读</h2>\n<ul>\n<li><a href=\"https://www.cnblogs.com/yuanchenhui/p/ofdreaderNew.html\">OFD极速阅读器：免费、好用！更多功能持续完善中！</a></li>\n</ul>\n","_path":"20240808/shi-yong-c-kai-fa-pdf-yue-du-qi-chu-tan-ji-yu-wpf-mei-you-shi-yong-kai-yuan-ku/","_link":"https://yaoqs.github.io/20240808/shi-yong-c-kai-fa-pdf-yue-du-qi-chu-tan-ji-yu-wpf-mei-you-shi-yong-kai-yuan-ku/","_id":"clzpq9hwo0076sgereyoa4cw7"}}