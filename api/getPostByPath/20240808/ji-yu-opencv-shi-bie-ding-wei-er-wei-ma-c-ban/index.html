{"type":"getPostByPath","data":{"title":"基于opencv 识别、定位二维码 （c++版）","date":"2024-08-08T03:39:53.000Z","description":"","categories":[{"name":"opencv","_id":"clzpq9hxs008usgerfff6a9p1"},{"name":"qrcode","_id":"clzpq9hy00095sger2suu8hg6"},{"name":"c++","_id":"clzpq9hyb009esgergn2r9hxi"}],"tags":[{"name":"opencv","_id":"clzpq9hv7004msgerffnr3eux"},{"name":"c++","_id":"clzpq9hyy00ahsgeragj8504x"},{"name":"qrcode","_id":"clzpq9hzl00cbsger1tjv4mgs"}],"content":"<p>转载自<a href=\"https://www.cnblogs.com/yuanchenhui/p/opencv_qr.html\">基于opencv 识别、定位二维码 （c++版）</a></p>\n<h2 id=\"前言\"><a class=\"header-anchor\" href=\"#前言\">※</a>前言</h2>\n<p>因工作需要，需要定位图片中的二维码；我遂查阅了相关资料，也学习了opencv开源库。通过一番努力，终于很好的实现了二维码定位。本文将讲解如何使用opencv定位二维码。</p>\n<p>定位二维码不仅仅是为了识别二维码；还可以通过二维码对图像进行水平纠正以及相邻区域定位。定位二维码，不仅需要图像处理相关知识，还需要分析二维码的特性，本文先从二维码的特性讲起。</p>\n<h2 id=\"二维码特性\"><a class=\"header-anchor\" href=\"#二维码特性\">※</a>二维码特性</h2>\n<p>二维码在设计之初就考虑到了识别问题，所以二维码有一些特征是非常明显的。二维码有三个“回“”字形图案，这一点非常明显。中间的一个点位于图案的左上角，如果图像偏转，也可以根据二维码来纠正。</p>\n<p><img src=\"245753-20190607193711542-878353158.jpg\" alt=\"\"></p>\n<p>思考题：为什么是三个点，而不是一个、两个或四个点。</p>\n<p>一个点：特征不明显，不易定位。不易定位二维码倾斜角度。</p>\n<p>两个点：两个点的次序无法确认，很难确定二维码是否放正了。</p>\n<p>四个点：无法确定4个点的次序，从而无法确定二维码是否放正了。</p>\n<p>识别二维码，就是识别二维码的三个点，逐步分析一下这三个点的特性</p>\n<ol>\n<li>每个点有两个轮廓。就是两个口，大“口”内部有一个小“口”，所以是两个轮廓。</li>\n<li>如果把这个“回”放到一个白色的背景下，从左到右，或从上到下画一条线。这条线经过的图案黑白比例大约为：黑白比例为1:1:3:1:1。</li>\n<li>如何找到左上角的顶点？这个顶点与其他两个顶点的夹角为90度。</li>\n</ol>\n<p>通过上面几个步骤，就能识别出二维码的三个顶点，并且识别出左上角的顶点。</p>\n<h2 id=\"使用opencv识别二维码\"><a class=\"header-anchor\" href=\"#使用opencv识别二维码\">※</a>使用opencv识别二维码</h2>\n<h3 id=\"查找轮廓-筛选出三个二维码顶点\"><a class=\"header-anchor\" href=\"#查找轮廓-筛选出三个二维码顶点\">※</a>查找轮廓,筛选出三个二维码顶点</h3>\n<p>opencv一个非常重要的函数就是查找轮廓，就是可以找到一个图中的缩所有的轮廓，“回”字形图案是一个非常的明显的轮廓，很容易找到。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">QrParse::FindQrPoint</span><span class=\"params\">(Mat&amp; srcImg, vector&lt;vector&lt;Point&gt;&gt;&amp; qrPoint)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//彩色图转灰度图</span></span><br><span class=\"line\">    Mat src_gray;</span><br><span class=\"line\">    <span class=\"built_in\">cvtColor</span>(srcImg, src_gray, CV_BGR2GRAY);</span><br><span class=\"line\">    <span class=\"built_in\">namedWindow</span>(<span class=\"string\">&quot;src_gray&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">imshow</span>(<span class=\"string\">&quot;src_gray&quot;</span>, src_gray);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//二值化</span></span><br><span class=\"line\">    Mat threshold_output;</span><br><span class=\"line\">    <span class=\"built_in\">threshold</span>(src_gray, threshold_output, <span class=\"number\">0</span>, <span class=\"number\">255</span>, THRESH_BINARY | THRESH_OTSU);</span><br><span class=\"line\">    Mat threshold_output_copy = threshold_output.<span class=\"built_in\">clone</span>();</span><br><span class=\"line\">    <span class=\"built_in\">namedWindow</span>(<span class=\"string\">&quot;Threshold_output&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">imshow</span>(<span class=\"string\">&quot;Threshold_output&quot;</span>, threshold_output);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//调用查找轮廓函数</span></span><br><span class=\"line\">    vector&lt;vector&lt;Point&gt; &gt; contours;</span><br><span class=\"line\">    vector&lt;Vec4i&gt; hierarchy;</span><br><span class=\"line\">    <span class=\"built_in\">findContours</span>(threshold_output, contours, hierarchy, CV_RETR_TREE, CHAIN_APPROX_NONE, <span class=\"built_in\">Point</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//通过黑色定位角作为父轮廓，有两个子轮廓的特点，筛选出三个定位角</span></span><br><span class=\"line\">    <span class=\"type\">int</span> parentIdx = <span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"type\">int</span> ic = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; contours.<span class=\"built_in\">size</span>(); i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (hierarchy[i][<span class=\"number\">2</span>] != <span class=\"number\">-1</span> &amp;&amp; ic == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            parentIdx = i;</span><br><span class=\"line\">            ic++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (hierarchy[i][<span class=\"number\">2</span>] != <span class=\"number\">-1</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ic++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (hierarchy[i][<span class=\"number\">2</span>] == <span class=\"number\">-1</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            ic = <span class=\"number\">0</span>;</span><br><span class=\"line\">            parentIdx = <span class=\"number\">-1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       </span><br><span class=\"line\">       <span class=\"number\">45</span>         &#123;<span class=\"number\">47</span> </span><br><span class=\"line\">            <span class=\"comment\">//保存找到的三个黑色定位角</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isQr)</span><br><span class=\"line\">                qrPoint.<span class=\"built_in\">push_back</span>(contours[parentIdx]);</span><br><span class=\"line\"></span><br><span class=\"line\">            ic = <span class=\"number\">0</span>;</span><br><span class=\"line\">            parentIdx = <span class=\"number\">-1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>找到了两个轮廓的图元，需要进一步分析是不是二维码顶点，用到如下函数：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">QrParse::IsQrPoint</span><span class=\"params\">(vector&lt;Point&gt;&amp; contour, Mat&amp; img)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//最小大小限定</span></span><br><span class=\"line\">    RotatedRect rotatedRect = <span class=\"built_in\">minAreaRect</span>(contour);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rotatedRect.size.height &lt; <span class=\"number\">10</span> || rotatedRect.size.width &lt; <span class=\"number\">10</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//将二维码从整个图上抠出来</span></span><br><span class=\"line\">    cv::Mat cropImg = <span class=\"built_in\">CropImage</span>(img, rotatedRect);</span><br><span class=\"line\">    <span class=\"type\">int</span> flag = i++;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//横向黑白比例1:1:3:1:1</span></span><br><span class=\"line\">    <span class=\"type\">bool</span> result = <span class=\"built_in\">IsQrColorRate</span>(cropImg, flag);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>黑白比例判断函数：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//横向和纵向黑白比例判断</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">QrParse::IsQrColorRate</span><span class=\"params\">(cv::Mat&amp; image, <span class=\"type\">int</span> flag)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">bool</span> x = <span class=\"built_in\">IsQrColorRateX</span>(image, flag);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!x)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"type\">bool</span> y = <span class=\"built_in\">IsQrColorRateY</span>(image, flag);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> y;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//横向黑白比例判断</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">QrParse::IsQrColorRateX</span><span class=\"params\">(cv::Mat&amp; image, <span class=\"type\">int</span> flag)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> nr = image.rows / <span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"type\">int</span> nc = image.cols * image.<span class=\"built_in\">channels</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    vector&lt;<span class=\"type\">int</span>&gt; vValueCount;</span><br><span class=\"line\">    vector&lt;uchar&gt; vColor;</span><br><span class=\"line\">    <span class=\"type\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">    uchar lastColor = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    uchar* data = image.<span class=\"built_in\">ptr</span>&lt;uchar&gt;(nr);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; nc; i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        vColor.<span class=\"built_in\">push_back</span>(data[i]);</span><br><span class=\"line\">        uchar color = data[i]; <span class=\"number\">28</span> </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            lastColor = color;</span><br><span class=\"line\">            count++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (lastColor != color)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                vValueCount.<span class=\"built_in\">push_back</span>(count);</span><br><span class=\"line\">                count = <span class=\"number\">0</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            count++;</span><br><span class=\"line\">            lastColor = color;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (count != <span class=\"number\">0</span>)</span><br><span class=\"line\">        vValueCount.<span class=\"built_in\">push_back</span>(count);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (vValueCount.<span class=\"built_in\">size</span>() &lt; <span class=\"number\">5</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//横向黑白比例1:1:3:1:1</span></span><br><span class=\"line\">    <span class=\"type\">int</span> index = <span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"type\">int</span> maxCount = <span class=\"number\">-1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; vValueCount.<span class=\"built_in\">size</span>(); i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            index = i;</span><br><span class=\"line\">            maxCount = vValueCount[i];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (vValueCount[i] &gt; maxCount)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                index = i;</span><br><span class=\"line\">                maxCount = vValueCount[i];</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">//黑白比例1:1:3:1:1</span></span><br><span class=\"line\">    <span class=\"type\">float</span> rate = ((<span class=\"type\">float</span>)maxCount) / <span class=\"number\">3.00</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    cout &lt;&lt; <span class=\"string\">&quot;flag:&quot;</span> &lt;&lt; flag &lt;&lt; <span class=\"string\">&quot; &quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">float</span> rate2 = vValueCount[index - <span class=\"number\">2</span>] / rate;</span><br><span class=\"line\">    cout &lt;&lt; rate2 &lt;&lt; <span class=\"string\">&quot; &quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">IsQrRate</span>(rate2))</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    rate2 = vValueCount[index - <span class=\"number\">1</span>] / rate;</span><br><span class=\"line\">    cout &lt;&lt; rate2 &lt;&lt; <span class=\"string\">&quot; &quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">IsQrRate</span>(rate2))</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    rate2 = vValueCount[index + <span class=\"number\">1</span>] / rate;</span><br><span class=\"line\">    cout &lt;&lt; rate2 &lt;&lt; <span class=\"string\">&quot; &quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">IsQrRate</span>(rate2))</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    rate2 = vValueCount[index + <span class=\"number\">2</span>] / rate;</span><br><span class=\"line\">    cout &lt;&lt; rate2 &lt;&lt; <span class=\"string\">&quot; &quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"built_in\">IsQrRate</span>(rate2))</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//纵向黑白比例判断 省略</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">QrParse::IsQrColorRateY</span><span class=\"params\">(cv::Mat&amp; image, <span class=\"type\">int</span> flag)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">QrParse::IsQrRate</span><span class=\"params\">(<span class=\"type\">float</span> rate)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">     <span class=\"comment\">//大概比例 不能太严格</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> rate &gt; <span class=\"number\">0.6</span> &amp;&amp; rate &lt; <span class=\"number\">1.9</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"确定三个二维码顶点的次序\"><a class=\"header-anchor\" href=\"#确定三个二维码顶点的次序\">※</a>确定三个二维码顶点的次序</h3>\n<p>通过如下原则确定左上角顶点：二维码左上角的顶点与其他两个顶点的夹角为90度。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/ pointDest存放调整后的三个点，三个点的顺序如下</span><br><span class=\"line\"><span class=\"comment\">// pt0----pt1</span></span><br><span class=\"line\"><span class=\"comment\">// </span></span><br><span class=\"line\"><span class=\"comment\">// pt2</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">QrParse::AdjustQrPoint</span><span class=\"params\">(Point* pointSrc, Point* pointDest)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"type\">bool</span> clockwise;</span><br><span class=\"line\">    <span class=\"type\">int</span> index1[<span class=\"number\">3</span>] = &#123; <span class=\"number\">2</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span> &#125;;</span><br><span class=\"line\">    <span class=\"type\">int</span> index2[<span class=\"number\">3</span>] = &#123; <span class=\"number\">0</span>,<span class=\"number\">2</span>,<span class=\"number\">1</span> &#125;;</span><br><span class=\"line\">    <span class=\"type\">int</span> index3[<span class=\"number\">3</span>] = &#123; <span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">2</span> &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"type\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">3</span>; i++)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"type\">int</span> *n = index1;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(i==<span class=\"number\">0</span>)</span><br><span class=\"line\">            n = index1;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (i == <span class=\"number\">1</span>)</span><br><span class=\"line\">            n = index2;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> </span><br><span class=\"line\">            n = index3;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"number\">23</span>         <span class=\"keyword\">if</span> (angle &gt; <span class=\"number\">80</span> &amp;&amp; angle &lt; <span class=\"number\">99</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            pointDest[<span class=\"number\">0</span>] = pointSrc[n[<span class=\"number\">2</span>]];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (clockwise)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                pointDest[<span class=\"number\">1</span>] = pointSrc[n[<span class=\"number\">0</span>]];</span><br><span class=\"line\">                pointDest[<span class=\"number\">2</span>] = pointSrc[n[<span class=\"number\">1</span>]];</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                pointDest[<span class=\"number\">1</span>] = pointSrc[n[<span class=\"number\">1</span>]];</span><br><span class=\"line\">                pointDest[<span class=\"number\">2</span>] = pointSrc[n[<span class=\"number\">0</span>]];</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"通过二维码对图片矫正。\"><a class=\"header-anchor\" href=\"#通过二维码对图片矫正。\">※</a>通过二维码对图片矫正。</h3>\n<p>图片有可能是倾斜的，倾斜夹角可以通过pt0与pt1连线与水平线之间的夹角确定。二维码的倾斜角度就是整个图片的倾斜角度，从而可以对整个图片进行水平矫正。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//二维码倾斜角度</span></span><br><span class=\"line\"><span class=\"function\">Point <span class=\"title\">hor</span><span class=\"params\">(pointAdjust[<span class=\"number\">0</span>].x<span class=\"number\">+300</span>,pointAdjust[<span class=\"number\">0</span>].y)</span></span>; <span class=\"comment\">//水平线</span></span><br><span class=\"line\"><span class=\"type\">double</span> qrAngle = QrParse::<span class=\"built_in\">Angle</span>(pointAdjust[<span class=\"number\">1</span>], hor, pointAdjust[<span class=\"number\">0</span>], clockwise);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//以二维码左上角点为中心 旋转</span></span><br><span class=\"line\">Mat drawingRotation = Mat::<span class=\"built_in\">zeros</span>(<span class=\"built_in\">Size</span>(src.cols,src.rows), CV_8UC3);</span><br><span class=\"line\"><span class=\"type\">double</span> rotationAngle = clockwise? -qrAngle:qrAngle;</span><br><span class=\"line\">Mat affine_matrix = <span class=\"built_in\">getRotationMatrix2D</span>(pointAdjust[<span class=\"number\">0</span>], rotationAngle, <span class=\"number\">1.0</span>);<span class=\"comment\">//求得旋转矩阵</span></span><br><span class=\"line\"><span class=\"built_in\">warpAffine</span>(src, drawingRotation, affine_matrix, drawingRotation.<span class=\"built_in\">size</span>());</span><br></pre></td></tr></table></figure>\n<h3 id=\"二维码相邻区域定位\"><a class=\"header-anchor\" href=\"#二维码相邻区域定位\">※</a>二维码相邻区域定位</h3>\n<p>一般情况下，二维码在整个图中的位置是确定的。识别出二维码后，根据二维码与其他图的位置关系，可以很容易的定</p>\n<p><img src=\"245753-20190607194439344-725362793.jpg\" alt=\"\"></p>\n<h3 id=\"后记\"><a class=\"header-anchor\" href=\"#后记\">※</a>后记</h3>\n<p>作者通过查找大量资料，仔细研究了二维码的特征，从而找到了识别二维码的方法。网上也有许多识别二维码的方法，但是不够严谨。本文是将二维码的多个特征相结合来识别，这样更准确。这种识别方法已应用在公司的产品中，识别效果还是非常好的</p>\n","_path":"20240808/ji-yu-opencv-shi-bie-ding-wei-er-wei-ma-c-ban/","_link":"https://yaoqs.github.io/20240808/ji-yu-opencv-shi-bie-ding-wei-er-wei-ma-c-ban/","_id":"clzpq9hxb0081sgerfv3kfdkl"}}