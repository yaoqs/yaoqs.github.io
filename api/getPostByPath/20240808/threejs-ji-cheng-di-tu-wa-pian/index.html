{"type":"getPostByPath","data":{"title":"ThreeJS集成地图瓦片","date":"2024-08-08T01:22:10.000Z","description":"","categories":[{"name":"threejs","_id":"clzpq9hug003ksger4kj129vl"},{"name":"Cesium","_id":"clzpq9hv2004fsgere0zp3v1g"}],"tags":[{"name":"Cesium","_id":"clzpq9ht1001csger9abk4mrg"},{"name":"threejs","_id":"clzpq9hwk006wsgerbuvn033b"}],"content":"<p>转载自 <a href=\"https://www.tangyuecan.com/2019/09/27/threejs%e9%9b%86%e6%88%90%e5%9c%b0%e5%9b%be%e7%93%a6%e7%89%87/\">ThreeJS集成地图瓦片</a></p>\n<h2 id=\"前言\"><a class=\"header-anchor\" href=\"#前言\">※</a>前言</h2>\n<p>由于公司最近马上需要落成一套三维GIS系统，之前基于什么百度、高德、Echarts之类都太LOW了而且没有办法达到项目的要求。无奈只能硬着头皮设计，最后发现可以使用 ThreeJS来渲染三维模型同时将地图的瓦片落在三维场景底部实现整体功能，基于这个思路足足检索了大量内容足足搞了两天才落成一个基础的Demo，伤的一B。</p>\n<p>首先必须说一下，这个标题可能有一点标题党的意思了，我不是直接将瓦片数据丢给ThreeJS渲染的（难度太大没有那么多时间），而是借助其他框架整合最终实现这个功能的，如果你是真正的硬核玩家那就没办法了。不过选择成熟框架进行整合出来的最终效果我觉得远远高于直接使用ThreeJS。</p>\n<p><img src=\"hight1-1024x533.jpg\" alt=\"\"></p>\n<p><strong>DEM瓦片数据+卫星图瓦片数据在WebGL之中的渲染</strong></p>\n<p>那么我使用的框架是什么呢？那就是大名鼎鼎的CesiumJS，这个东西是全世界做GIS系统的开源项目之中最专业，最高效的框架，开源且免费！我这里一两句是没有办法说明它有多NB的，如果只论地图他可以把BAT、谷歌、微软等一下大厂的地图全部安在脚下摩擦。</p>\n<h2 id=\"版本依赖\"><a class=\"header-anchor\" href=\"#版本依赖\">※</a>版本依赖</h2>\n<ol>\n<li><a href=\"https://threejs.org/\">ThreeJS</a> 0.87.0</li>\n<li><a href=\"https://cesiumjs.org/\">Cesium</a> 1.61.0</li>\n</ol>\n<h2 id=\"集成原理\"><a class=\"header-anchor\" href=\"#集成原理\">※</a>集成原理</h2>\n<p>无论是Cesium还是ThreeJS都是基于WebGL渲染意味这两者的空间坐标是相对一致的，加之GIS系统核心在于GPS坐标数据与笛卡尔坐标系的对应关系，在三维空间上这个关系是无论对Cesium还是ThreeJS都是一致的只需要对其进行一层解析就可以了。同时两者的渲染管线一致所以很多WebGL的原生封装两者是可以直接共用的。</p>\n<p>集成上面最核心的部分就是将两个渲染引擎的渲染帧给同步，方式是将ThreeJS的帧生成函数与Cesium在同一帧调用完成，方式如下所示：</p>\n<p><strong>1、分别创建Cesium视图与ThreeJS视图</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> cesiumContainer = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">&quot;cesiumContainer&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> <span class=\"title class_\">ThreeContainer</span> = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">&quot;ThreeContainer&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">//创建Cesium视图</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> cesium = &#123;&#125;</span><br><span class=\"line\">cesium.<span class=\"property\">viewer</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Cesium</span>.<span class=\"title class_\">Viewer</span>(cesiumContainer, &#123;&#125;）；</span><br><span class=\"line\"><span class=\"comment\">//创建Three视图</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> three = &#123;&#125;；</span><br><span class=\"line\">three.<span class=\"property\">scene</span> = <span class=\"keyword\">new</span> <span class=\"variable constant_\">THREE</span>.<span class=\"title class_\">Scene</span>();</span><br><span class=\"line\">three.<span class=\"property\">camera</span> = <span class=\"keyword\">new</span> <span class=\"variable constant_\">THREE</span>.<span class=\"title class_\">PerspectiveCamera</span>(fov, aspect, near, far);</span><br><span class=\"line\">three.<span class=\"property\">renderer</span> = <span class=\"keyword\">new</span> <span class=\"variable constant_\">THREE</span>.<span class=\"title class_\">WebGLRenderer</span>(&#123;</span><br><span class=\"line\">  <span class=\"attr\">alpha</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"attr\">logarithmicDepthBuffer</span>:<span class=\"literal\">true</span></span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"title class_\">ThreeContainer</span>.<span class=\"title function_\">appendChild</span>(three.<span class=\"property\">renderer</span>.<span class=\"property\">domElement</span>)；</span><br></pre></td></tr></table></figure>\n<p><strong>2、将Cesium的渲染帧给禁用调用</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">viewer.<span class=\"property\">useDefaultRenderLoop</span> = <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n<p><strong>3、同步两者的相机，由于用户直接的操作的是Cesium所以最终要求将ThreeJS的相机同步到Cesium上,每一帧更新。</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//将Cesium的摄像头视场同步至THREE</span></span><br><span class=\"line\">three.<span class=\"property\">camera</span>.<span class=\"property\">fov</span> = <span class=\"title class_\">Cesium</span>.<span class=\"property\">Math</span>.<span class=\"title function_\">toDegrees</span>(cesium.<span class=\"property\">viewer</span>.<span class=\"property\">camera</span>.<span class=\"property\">frustum</span>.<span class=\"property\">fovy</span>);</span><br><span class=\"line\"><span class=\"comment\">//更新摄像头投影矩阵</span></span><br><span class=\"line\">three.<span class=\"property\">camera</span>.<span class=\"title function_\">updateProjectionMatrix</span>();</span><br><span class=\"line\"><span class=\"comment\">//关闭摄像头自动更新</span></span><br><span class=\"line\">three.<span class=\"property\">camera</span>.<span class=\"property\">matrixAutoUpdate</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"comment\">//获取Cesium相机矩阵</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> cvm = cesium.<span class=\"property\">viewer</span>.<span class=\"property\">camera</span>.<span class=\"property\">viewMatrix</span>;</span><br><span class=\"line\"><span class=\"comment\">//获取Cesium相机逆矩阵</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> civm = cesium.<span class=\"property\">viewer</span>.<span class=\"property\">camera</span>.<span class=\"property\">inverseViewMatrix</span>;</span><br><span class=\"line\"><span class=\"comment\">//设置three的世界坐标矩阵</span></span><br><span class=\"line\">three.<span class=\"property\">camera</span>.<span class=\"property\">matrixWorld</span>.<span class=\"title function_\">set</span>(</span><br><span class=\"line\">    civm[<span class=\"number\">0</span>], civm[<span class=\"number\">4</span>], civm[<span class=\"number\">8</span>], civm[<span class=\"number\">12</span>],</span><br><span class=\"line\">    civm[<span class=\"number\">1</span>], civm[<span class=\"number\">5</span>], civm[<span class=\"number\">9</span>], civm[<span class=\"number\">13</span>],</span><br><span class=\"line\">    civm[<span class=\"number\">2</span>], civm[<span class=\"number\">6</span>], civm[<span class=\"number\">10</span>], civm[<span class=\"number\">14</span>],</span><br><span class=\"line\">    civm[<span class=\"number\">3</span>], civm[<span class=\"number\">7</span>], civm[<span class=\"number\">11</span>], civm[<span class=\"number\">15</span>]</span><br><span class=\"line\">);</span><br><span class=\"line\">three.<span class=\"property\">camera</span>.<span class=\"property\">matrixWorldInverse</span>.<span class=\"title function_\">set</span>(</span><br><span class=\"line\">    cvm[<span class=\"number\">0</span>], cvm[<span class=\"number\">4</span>], cvm[<span class=\"number\">8</span>], cvm[<span class=\"number\">12</span>],</span><br><span class=\"line\">    cvm[<span class=\"number\">1</span>], cvm[<span class=\"number\">5</span>], cvm[<span class=\"number\">9</span>], cvm[<span class=\"number\">13</span>],</span><br><span class=\"line\">    cvm[<span class=\"number\">2</span>], cvm[<span class=\"number\">6</span>], cvm[<span class=\"number\">10</span>], cvm[<span class=\"number\">14</span>],</span><br><span class=\"line\">    cvm[<span class=\"number\">3</span>], cvm[<span class=\"number\">7</span>], cvm[<span class=\"number\">11</span>], cvm[<span class=\"number\">15</span>]</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"comment\">//重置视角</span></span><br><span class=\"line\">three.<span class=\"property\">camera</span>.<span class=\"title function_\">lookAt</span>(<span class=\"keyword\">new</span> <span class=\"variable constant_\">THREE</span>.<span class=\"title class_\">Vector3</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>));</span><br></pre></td></tr></table></figure>\n<p><strong>4、同步ThreeJS的三维物体，每一帧都需要更新</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//_3DOBS是一个数组，数组之中的每一个元素都包含一个three的Object3D、经度、维度三项数据。</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> id <span class=\"keyword\">in</span> _3DOBS) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//获取经纬度</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"title class_\">LnL</span> = [_3DOBS[id].<span class=\"property\">longitude</span>, _3DOBS[id].<span class=\"property\">dimension</span>];</span><br><span class=\"line\">    <span class=\"comment\">//获取经纬度原点坐标</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> center = <span class=\"title class_\">Cesium</span>.<span class=\"property\">Cartesian3</span>.<span class=\"title function_\">fromDegrees</span>(<span class=\"title class_\">LnL</span>[<span class=\"number\">0</span>], <span class=\"title class_\">LnL</span>[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    <span class=\"comment\">//获取经纬度原点坐标向上一个单位的坐标</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> centerHigh = <span class=\"title class_\">Cesium</span>.<span class=\"property\">Cartesian3</span>.<span class=\"title function_\">fromDegrees</span>(<span class=\"title class_\">LnL</span>[<span class=\"number\">0</span>], <span class=\"title class_\">LnL</span>[<span class=\"number\">1</span>], <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"comment\">//重置模型位置</span></span><br><span class=\"line\">    _3DOBS[id].<span class=\"property\">Group</span>.<span class=\"property\">position</span>.<span class=\"title function_\">copy</span>(center);</span><br><span class=\"line\">    <span class=\"comment\">//重置模型方向</span></span><br><span class=\"line\">    _3DOBS[id].<span class=\"property\">Group</span>.<span class=\"title function_\">lookAt</span>(centerHigh);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//还有一步操作，因为Cesium是y轴向上所以需要将three的Object3D对象在X轴方向翻转90度。</span></span><br></pre></td></tr></table></figure>\n<p><strong>5、同步两个渲染器的渲染</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">three.<span class=\"property\">Render</span> = <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//这里的this是three对象</span></span><br><span class=\"line\">    <span class=\"title function_\">requestAnimationFrame</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">Render</span>);</span><br><span class=\"line\">    <span class=\"comment\">//渲染cesium</span></span><br><span class=\"line\">    渲染cesium.<span class=\"property\">viewer</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    <span class=\"comment\">//渲染three</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> width = <span class=\"title class_\">ThreeContainer</span>.<span class=\"property\">clientWidth</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> height = <span class=\"title class_\">ThreeContainer</span>.<span class=\"property\">clientHeight</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> aspect = width / height;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">camera</span>.<span class=\"property\">aspect</span> = aspect;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">camera</span>.<span class=\"title function_\">updateProjectionMatrix</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">renderer</span>.<span class=\"title function_\">setSize</span>(width, height);</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">renderer</span>.<span class=\"title function_\">render</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">scene</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">camera</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最后将两者对应的dom对象重叠在一起，Three在上层，Cesium在下层，将Three的事件捕捉禁用，启用背景透明。这些步骤之后两个渲染器基本上就可以协同工作了，后续可以自行对两个渲染器进行封装，然后分别实现各自的功能。</p>\n<h2 id=\"特性\"><a class=\"header-anchor\" href=\"#特性\">※</a>特性</h2>\n<h3 id=\"1、完整的ThreeJS功能\"><a class=\"header-anchor\" href=\"#1、完整的ThreeJS功能\">※</a>1、完整的ThreeJS功能</h3>\n<p><img src=\"three.jpg\" alt=\"\"></p>\n<p><strong>ThreeJS场景下导入的基于PBR渲染的GLTF模型</strong></p>\n<p>在渲染器的基础之上没有对THREE做任何修改，所以ThreeJS上拥有的特性全部可以无缝应用在这个项目之中，无论是粒子、动画、物理学模拟等等。由于这个特性存在，无论什么大场景的三维可视化、GIS系统或者是一些大型工程的BIM都可以轻松实现，至少在地图上已经赢了。即便是对ThreeJS的操作事件其实可以通过下层Cesium透传回来。</p>\n<h3 id=\"2、各种地图瓦片数据对接\"><a class=\"header-anchor\" href=\"#2、各种地图瓦片数据对接\">※</a>2、各种地图瓦片数据对接</h3>\n<p><img src=\"baidu.jpg\" alt=\"\"></p>\n<p><strong>高德瓦片集成效果</strong></p>\n<p>目前我所知道的，无论是谷歌、高德、百度、腾讯还是其他乱七八糟的地图都是采用瓦片数据对整个地球进行分割虽然各家的瓦片完全不一样，但是格式是完全一样的，这就意味着他们是通用的，而且Cesium可以对接这些数据。</p>\n<p>瓦片数据上我大概知道的有：</p>\n<ul>\n<li>高德卫星：<a href=\"http://webst02.is.autonavi.com/appmaptile?style=6&amp;x=%7Bx%7D&amp;y=%7By%7D&amp;z=%7Bz%7D\">http://webst02.is.autonavi.com/appmaptile?style=6&amp;x={x}&amp;y={y}&amp;z={z}</a></li>\n<li>百度卫星：<a href=\"http://shangetu1.map.bdimg.com/it/u=x=%7Bx%7D;y=%7By%7D;z=%7Bz%7D;v=009;type=sate&amp;fm=46\">http://shangetu1.map.bdimg.com/it/u=x={x};y={y};z={z};v=009;type=sate&amp;fm=46</a></li>\n<li>谷歌卫星：<a href=\"http://www.google.cn/maps/vt?lyrs=m&amp;gl=CN&amp;x=%7Bx%7D&amp;y=%7By%7D&amp;z=%7Bz%7D\">http://www.google.cn/maps/vt?lyrs=m&amp;gl=CN&amp;x={x}&amp;y={y}&amp;z={z}</a></li>\n<li>OMS地图：<a href=\"https://c.tile.openstreetmap.org/%7Bz%7D/%7Bx%7D/%7By%7D.png\">https://c.tile.openstreetmap.org/{z}/{x}/{y}.png</a></li>\n</ul>\n<p>大概试了一下谷歌地图不但没有被墙而且访问速度还非常的快，整体无论是精度还是数据量都远远超过国产地图，妈的，主场优势的BAT简直丢脸。</p>\n<h3 id=\"3-地形DEM数据可视化\"><a class=\"header-anchor\" href=\"#3-地形DEM数据可视化\">※</a>3.地形DEM数据可视化</h3>\n<p><img src=\"hight.jpg\" alt=\"\"></p>\n<p><strong>这个效果无敌了</strong></p>\n<p>这个虽然看起来比较科幻，但是人家谷歌在多年前就已经有了，那就是将DEM数据在浏览器地图之中展示。不得不说这个还是效果还是NB的，但是人家谷歌使用的高度贴图，Cesium其实有点悲剧没有办法直接使用谷歌的高度贴图（至少我没有找到，谁知道可以给我说一下），所以就退而求其次使用第三方的DEM数据，比较痛苦的是Cesium官方其实是有一套全球14级的DEM数据的基本上开箱即用，但是国内访问速度太慢了，所以要不然就自己按照其规则去下载DEM数据然后自己搭建，我看了一下CSDN上有一个老哥搞了一个教程可以学习一波地址是：<a href=\"https://blog.csdn.net/u013821237/article/details/82999006\">点击跳转</a>，但是比较伤的是数据转换之后太大了服务器带宽不够所以我还是去找了一下国内速度比较快的最终还真就找到了一个全中国14级DEM，速度飞快：</p>\n<p><a href=\"https://lab.earthsdk.com/terrain/577fd5b0ac1f11e99dbd8fd044883638\">https://lab.earthsdk.com/terrain/577fd5b0ac1f11e99dbd8fd044883638</a></p>\n<p>最终的效果就是上图的样子了</p>\n<h3 id=\"4、CZML数据文件封装\"><a class=\"header-anchor\" href=\"#4、CZML数据文件封装\">※</a>4、CZML数据文件封装</h3>\n<p><img src=\"data-1024x722.jpg\" alt=\"\"></p>\n<p><strong>官网的卫星数据可视化Demo效果</strong></p>\n<p>这个东西我还没有完全搞懂，但是意思是非常清楚的，基本意味着GIS上能够用得上的所有数据呈现都有一个特定格式进行封装，包含了动画、路径、图标等等，我大概在官方Demo上看了一会，目前只能看看没有办法直接开始写但是东西就是这个东西，后续必须要学习一下，非常的震撼。</p>\n<h2 id=\"已知问题\"><a class=\"header-anchor\" href=\"#已知问题\">※</a>已知问题</h2>\n<p>1、目前的三维坐标转换函数只能在球面地图上良好的转换，平面上不行，主要是经纬度解析会GG。</p>\n<p><img src=\"plan-1024x409.jpg\" alt=\"\"></p>\n<p><strong>不是二维，是平面！</strong></p>\n<p>2、ThreeJS在0.87之后所有版本不知道为什么无法正常转换坐标，目前只能用0.87也将就一下了。</p>\n<h2 id=\"总结\"><a class=\"header-anchor\" href=\"#总结\">※</a>总结</h2>\n<p>以后任何可以使用GIS技术的项目应该都不会虚了，毕竟有了这些东西你告诉我什么效果实现不了？上文的内容基本上已经足够把基础的框架给搭建出来，我不会直接给你我搭建的源码毕竟不认真理解一波自己搭建起来是学不到任何东西的。</p>\n","_path":"20240808/threejs-ji-cheng-di-tu-wa-pian/","_link":"https://yaoqs.github.io/20240808/threejs-ji-cheng-di-tu-wa-pian/","_id":"clzpq9hu30030sgerhsnngpdv"}}