{"type":"getPostByPath","data":{"title":"Cesium 生成terrain地形数据----CTB方式及步骤","date":"2024-08-08T01:40:34.000Z","description":"","categories":[{"name":"Cesium","_id":"clzpq9hsn000vsgera90ugkn1"}],"tags":[{"name":"Cesium","_id":"clzpq9ht1001csger9abk4mrg"}],"content":"<p>转载自 <a href=\"https://blog.csdn.net/u013821237/article/details/82999006\">Cesium 生成terrain地形数据----CTB方式及步骤</a></p>\n<h2 id=\"Cesium-生成terrain地形数据-CTB方式及步骤\"><a class=\"header-anchor\" href=\"#Cesium-生成terrain地形数据-CTB方式及步骤\">※</a>Cesium 生成terrain地形数据----CTB方式及步骤</h2>\n<p><strong>后记</strong>：如果你只是需要将tif处理成terrain,而不是学习处理过程，可以直接使用这个简单的工具：<a href=\"https://www.cesiumlab.com/\">CesiumLab</a>。不需要拼接成一个TIF，也不需要处理No-Data，地形功能免费。如果对你有用，点个赞加个关注吧๑乛◡乛๑</p>\n<p><strong>背景</strong>：项目前端使用Cesium，地形服务一直使用外网的，常常因为翻墙访问的问题，导致地形数据取不到，进而导致地球不能加载，故决定搭建自己的地形服务，彻底解决这个问题。博文包含以下几个过程：</p>\n<ol>\n<li>下载原始地形数据，格式为.tif。</li>\n<li>处理地形数据，将零散的地形文件整合成一个地形文件。</li>\n<li>配置CTB环境</li>\n<li>使用ctb-tile指令将地形文件(.tif)加工成.terrain文件。</li>\n<li>发布地形服务并使用Cesium调用。</li>\n</ol>\n<p><strong>一、下载原始地形数据</strong></p>\n<ul>\n<li>下载地址(精度90m)：<br>\n<a href=\"http://srtm.csi.cgiar.org/SELECTION/inputCoord.asp\">http://srtm.csi.cgiar.org/SELECTION/inputCoord.asp</a></li>\n<li>如果你刚好需要的也是全国地形，可以从楼主网盘下载，更快更方便(密码zyt9)：<a href=\"https://pan.baidu.com/s/1YYC25b48QAVb64mW77vCEw\">https://pan.baidu.com/s/1YYC25b48QAVb64mW77vCEw</a></li>\n</ul>\n<p>网盘包含两部分内容：</p>\n<ul>\n<li>dem.rar：原始数据，需要自行使用ArcMap工具整合。</li>\n<li>合并后的数据：经过ArcMap工具处理的数据，已经整合成了一个地形文件，可以直接跳到第三步。</li>\n</ul>\n<p>在网站下载流程：</p>\n<ol>\n<li>打开网页<a href=\"http://srtm.csi.cgiar.org/SELECTION/inputCoord.asp\">http://srtm.csi.cgiar.org/SELECTION/inputCoord.asp</a>。如图:<img src=\"83458d1da4d4efd1ac0c63f9144bb1c0.png\" alt=\"\"></li>\n<li>根据需要选择方便的选取方式：<br>\n<img src=\"4877359c02f4cff77a8fc89c18354288.png\" alt=\"\"><br>\nMutilpleSelection:点击哪个选哪个，可以选择多个，双击取消。<br>\nEnableMouseDrag:框选，框选了什么范围就是什么范围。<br>\nInputCoordinates:输入最西，最东。最南，最北的坐标来下载该范围内的所有数据。</li>\n<li>选择好范围后，点击“Click here to Begin Search”,进入下一步。</li>\n<li>可以看到刚刚选择了几个数据，点击每个数据的DownLoad，下载数据（这个地方比较繁琐，需要耐心）。<img src=\"961a87cf6d8f16386a93ca1ae541a224.png\" alt=\"\"></li>\n<li>下载完数据后解压所有的压缩包，并将tifwen文件拷贝到统一的文件夹内，这里的内容和我网盘中的dem.rar是一样的：<img src=\"12d63cc76c88288935a176b218732473.png\" alt=\"\"></li>\n</ol>\n<p><strong>二、处理地形数据</strong></p>\n<p>由于CTB工具不支持DEM为NoData值和float的数据，所以需要对数据进行处理。</p>\n<ul>\n<li>多个tif必须县合并镶嵌成一张tif</li>\n<li>pixeltype从float转为int</li>\n<li>NoData值处理为0</li>\n</ul>\n<p>我使用的是ArcGis10.5，打开ArcMap:</p>\n<p><img src=\"a588c4ed057d2e4251d82af12073ba1b.png\" alt=\"\"></p>\n<p>打开 ArcToolbox-&gt;Data Management Tools-&gt;Raster-&gt;Raster Dataset -&gt;Mosaic。</p>\n<p><img src=\"a61f153ab83f41563c698835f6163eec.png\" alt=\"\"></p>\n<p>这个处理过程很久，可以在Result面板里查看转换过程。</p>\n<p>成功后，处理NoData值，ArcToolbox-&gt;spatial Analyst Tool-&gt;Map Algebra-&gt;Raster Calculator 处理公式为:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Con</span>(<span class=\"title class_\">IsNull</span>(<span class=\"string\">&quot;xxxx.tif&quot;</span>),<span class=\"number\">0</span>,<span class=\"string\">&quot;xxxx.tif&quot;</span>)<span class=\"comment\">//xxxx.tif对应你的合并后的文件</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"e285c07f76d71e60c908e82c33f2b964.png\" alt=\"\"></p>\n<p><strong>三、配置CTB环境</strong></p>\n<ol>\n<li>下载CTB工具包：<a href=\"https://download.csdn.net/download/u013821237/10711947\">资源</a> （没有积分的可以加我QQ）</li>\n<li>将ctb和gdal-data拷贝至合适的目录下如：D:\\soft\\CTB</li>\n<li>配置环境变量：                                                             <img src=\"af7d27e9adc3b550afdae8cb27310f6f.png\" alt=\"\"></li>\n</ol>\n<p><strong>四、使用CTB生成.terrain文件：</strong></p>\n<p>注意：执行前请确保输出文件夹存在且是空的，同时保证磁盘有足够的空间，全球数据大约800G。生成瓦片的等级不要太高，中国范围内单18级就需要大约700G。</p>\n<p>打开cmd控制台,输入指令如：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ctb-tile -o D:\\terrain\\china\\terrain -s 14 -e 0 -r nearest -c 4 C:\\Users\\Administrator\\Documents\\ArcGIS\\dem_result\\noData\\new.tif</span><br></pre></td></tr></table></figure>\n<p><img src=\"67a6fe49c23a3cd3e806b66aaa0f7a8c.png\" alt=\"\"></p>\n<p>这个过程更加费时间，需要等待很久，直到执行结束。</p>\n<p><strong>五、发布并使用Cesium调用</strong></p>\n<ol>\n<li>\n<p>将生成的文件拷贝到Tomcat服务器下。</p>\n</li>\n<li>\n<p>拷贝“覆盖至生成tiles结果”目录中的layer.json文件和0文件夹至生成结果目录下：<img src=\"a6a22b45cc633923c627d30d39d4c7fb.png\" alt=\"\"></p>\n</li>\n<li>\n<p>调用代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> terrainLayer = <span class=\"keyword\">new</span> <span class=\"title class_\">Cesium</span>.<span class=\"title class_\">CesiumTerrainProvider</span>(&#123;</span><br><span class=\"line\">        <span class=\"attr\">url</span>: <span class=\"string\">&quot;http://localhost:8080/terrain&quot;</span>, <span class=\"comment\">// 默认立体地表</span></span><br><span class=\"line\">     &#125;);</span><br><span class=\"line\">scene.<span class=\"property\">terrainProvider</span> = terrainLayer;</span><br></pre></td></tr></table></figure>\n<p>至此，地形发布完成。如有错误之处欢迎指正。</p>\n</li>\n</ol>\n","_path":"20240808/cesium-sheng-cheng-terrain-di-xing-shu-ju-ctb-fang-shi-ji-bu-zou/","_link":"https://yaoqs.github.io/20240808/cesium-sheng-cheng-terrain-di-xing-shu-ju-ctb-fang-shi-ji-bu-zou/","_id":"clzpq9hsc000lsger1pqb1qp4"}}